<?php  if (!defined('BASEPATH')) exit('No direct script access allowed'); ?>

<script type="text/javascript">
    var page = {
        'site_url' : '{site_url}',
        'template_files': '{site_url}themes/{template}/{style}/',
        'system_template': '{site_url}themes/system/',
        'csrf_token_name' : '{csrf_token_name}',
        'csrf_hash' : '{csrf_hash}',
        'server_id' : {server_id}
    };

    var confirm_msg = {
        "gsstart": "Вы уверены, что хотите запустить сервер?",
        "gsstop": "Вы уверены, что хотите остановить сервер?",
        "gsrest": "Вы уверены, что хотите перезапустить сервер?",
        "gsinst": "Вы уверены, что хотите обновить сервер?"
    };

    var messages = {
        "gsstart": ["Ожидание очереди", "Запуск сервера", "Проверка статуса"],
        "gsstop": ["Ожидание очереди", "Остановка сервера", "Проверка статуса"],
        "gsrest": ["Ожидание очереди", "Перезапуск сервера", "Проверка статуса"],
        "gsinst": ["Ожидание очереди", "Обновление сервера", "Проверка результата"]
    };

    var success_messages = {
        "gsstart": "Сервер успешно запущен. <br />Некоторое время он может быть оффлайн пока не загрузятся ресурсы, плагины, карта и т.д. Результат загрузки ресурсов можно видеть в консоли и логах сервера.",
        "gsstop": "Сервер успешно остановлен.",
        "gsrest": "Сервер успешно перезапущен. <br />Некоторое время он может быть оффлайн пока не загрузятся ресурсы, плагины, карта и т.д. Результат загрузки ресурсов можно видеть в консоли и логах сервера.",
        "gsinst": "Сервер обновлён."
    };

    var error_messages = {
        "gsstart": "Ошибка запуска сервера.",
        "gsstop": "Ошибка остановки сервера.",
        "gsrest": "Ошибка перезапуска сервера.",
        "gsinst": "Ошибка обновления."
    };

    var message_title = {
        "gsstart": "Запуск сервера",
        "gsstop": "Остановка сервера",
        "gsrest": "Перезапуск сервера",
        "gsinst": "Обновление сервера"
    };
</script>

<script>
    // 0 - not get, 1 - getting, 2 - active, 3 - not active
    var server_status = 0;

    function get_server_status(server_id)
    {
        server_status = 1;

        $.ajax({ 
            url:    sprintf("%sajax/server_control/get_status/%s", page.site_url, server_id),
            type:     "GET",
            dataType: "json",
            success: function(response) {
                if (response.status == '0') {
                    return;
                } else {
                    if (response.data.process_active == 1) {
                        server_status = 2;
                    } else {
                        server_status = 3;
                    }
                }
            },
            error: function() {
                // noty({layout: 'bottomCenter', type: 'error', text: "unknown error"});s
            },
            complete: function() {
                // block = false;
            }
        });
    }
</script>

<script>
    block = false;

    task_status = '';
    check_timeout = 2000;

    function get_task_info(task_id)
    {
        $.ajax({ 
            url:    sprintf("%sajax/tasks/get_info/%s", page.site_url, task_id),
            type:     "GET",
            dataType: "json",
            success: function(response) {
                if (response.status == '0') {
                    noty({layout: 'bottomCenter', type: 'error', text: response.error_text});
                    return;
                } else {
                    task_status = response.data.status;
                }
            },
            error: function() {
                noty({layout: 'bottomCenter', type: 'error', text: "unknown error"});
            },
            complete: function() {
                HideLoad();
                block = false;
            }
        });
    }

    check_step = 0;
    task_result = 0;
    function check_task(task, task_id)
    {
        intervalID = null;

        function check_task_start()
        {
            get_task_info(task_id);

            if (task_status != 'waiting' && task_status != '') {
                clearInterval(intervalID);
                check_step = 1;
                check_task(task, task_id);
            }
        }

        function check_task_end()
        {
            get_task_info(task_id);

            if ((task_status == 'success' || task_status == 'error') && task_status != '') {
                clearInterval(intervalID);
                check_step = 2;
                check_task(task, task_id);
            }
        }
        
        function check_task_result()
        {
            if (task != 'gsstart' && task != 'gsstop' && task != 'gsrest') {
                clearInterval(intervalID);

                task_result = 1;
                check_step = 3;
                check_task(task, task_id);
            }

            if (server_status == 0) {
                get_server_status(page.server_id);
            }
            
            if (task == 'gsstart' || task == 'gsrest') {
                if (server_status == 2) {
                    clearInterval(intervalID);

                    task_result = 1;
                    check_step = 3;
                    check_task(task, task_id);
                } else if (server_status == 3) {
                    clearInterval(intervalID);

                    task_result = 0;
                    check_step = 3;
                    check_task(task, task_id);
                }
            }

            if (task == 'gsstop') {
                if (server_status == 3) {
                    clearInterval(intervalID);

                    task_result = 1;
                    check_step = 3;
                    check_task(task, task_id);
                } else if (server_status == 2) {
                    clearInterval(intervalID);

                    task_result = 0;
                    check_step = 3;
                    check_task(task, task_id);
                }
            }
            
            // check_task(task, task_id);
        }

        if (check_step == 0) {
            $(".task-progress-header").html(message_title[task]);
            $("#vts-content").html("");
            $("#vts-content").append("<span class=\"vts-progress\">" + messages[task][0] + "...</span>");
            intervalID = setInterval(check_task_start, check_timeout);
        }

        if (!intervalID && check_step == 1) {
            $('.vts-progress').last().remove();
            $("#vts-content").append("<span class=\"vts-progress\">&#10003; " + messages[task][0] + "</span><br />\n");
            $("#vts-content").append("<span class=\"vts-progress\">" + messages[task][1] + "...</span>");
            
            intervalID = setInterval(check_task_end, check_timeout);
        }

        if (!intervalID && check_step == 2) {
            $('.vts-progress').last().remove();
            $("#vts-content").append("<span class=\"vts-progress\">&#10003; " + messages[task][1] + "</span><br />\n");
            $("#vts-content").append("<span class=\"vts-progress\">" + messages[task][2] + "...</span>\n");
            intervalID = setInterval(check_task_result, check_timeout);
        }

        if (!intervalID && check_step == 3) {
            // End
            $('.vts-progress').last().remove();
            $("#vts-content").append("<span class=\"vts-progress\">&#10003; " + messages[task][2] + "</span><br />\n");

            if (task_result) {
                $('#view-task-status').arcticmodal('close');
                noty({
                    layout: 'center',
                    type: 'success',
                    text: success_messages[task],
                    callback: {
                        onClose: function() {
                            location.reload();
                        }
                    }
                });
            }
            else {
                $('#view-task-status').arcticmodal('close');
                
                noty({
                    layout: 'center',
                    type: 'error',
                    text: error_messages[task]
                });
            }

            // Var nulled
            check_step      = 0;
            task_status     = '';
            task_result     = 0;
        }
    }

    function add_task(task)
    {
        if (block == true) {
            return;
        }

        block = true;
        ShowLoad();
        
        $.ajax({
            url: sprintf("%sajax/tasks/add_task", page.site_url),
            type: "POST",
            data:
            {
                'task': task,
                'server_id': {server_id},
                '{csrf_token_name}': '{csrf_hash}'
            },
            dataType: "json",
            success: function(response) {
                if (response.status == '0') {
                    noty({layout: 'bottomCenter', type: 'error', text: response.error_text});
                    return;
                } else {
                    // noty({layout: 'bottomCenter', type: 'success', text: "Success"});
                    $('#view-task-status').arcticmodal();
                    check_task(task, response.task_id);
                }
            },
            error: function() {
                noty({layout: 'bottomCenter', type: 'error', text: "unknown error"});
            },
            complete: function() {
                HideLoad();
                block = false;
            }
        });
    }

    function server_act(task)
    {
        noty({
            layout: 'center',
            type: 'confirm',
            text: confirm_msg[task],
            buttons: [
                {addClass: 'btn btn-primary', text: '{lang_yes}', onClick: function($noty) {
                        $noty.close();
                        add_task(task);
                    }
                },
                {addClass: 'btn btn-danger', text: '{lang_no}', onClick: function($noty) {
                        $noty.close();
                    }
                }
            ]
        });
    }

</script>

<p class="hr"><strong>{lang_server_control_base_commands}</strong></p>

<div style="display: none;">
    <div class="box-modal" style="width: 300px;" id="view-task-status">
        <div class="box-modal_close arcticmodal-close">close</div>
        <h2 class="task-progress-header"></h2>

        <div id="vts-content">

        </div>
    </div>
</div>

<?php 
if(($this->users->auth_privileges['srv_start'] == 1 
		AND $this->users->auth_servers_privileges['SERVER_START'])
	AND ($this->servers->server_data['server_status'] == 0)
):

?>
	<a id="start-server" class="large green awesome" href="#">&#9658;&nbsp;{lang_start}</a>
<?php endif; ?>

<?php 
if(($this->users->auth_privileges['srv_stop'] == 1 
		AND $this->users->auth_servers_privileges['SERVER_STOP'])
	AND ($this->servers->server_data['server_status'] == 1)
):
?>
	<a id="stop-server" class="large red awesome" href="#">&#9632;&nbsp;{lang_stop}</a>
<?php endif; ?>

<?php 
if($this->users->auth_privileges['srv_restart'] == 1 
	AND $this->users->auth_servers_privileges['SERVER_RESTART']
):
?>
	<a id="restart-server" class="large yellow awesome" href="#">&#10162;&nbsp;{lang_restart}</a>
<?php endif; ?>

<?php if($this->users->auth_servers_privileges['SERVER_SOFT_RESTART'] AND $this->servers->server_data['srestart_cmd']): ?>
	<a class="large blue awesome" href="{site_url}server_command/rcon/restart/{server_id}/{csrf_hash}">&#10162;&nbsp;{lang_soft_restart}</a>
<?php endif; ?>

<?php if($this->users->auth_servers_privileges['SERVER_UPDATE']): ?>
	<a id="update-server" class="large magenta awesome" href="#">&#10162;&nbsp;{lang_update}</a>
<?php endif; ?>

<p class="hr"><strong>Инструменты</strong></p>

<div style="overflow: hidden;">
    <div style="width: 100%;">
		<?php if( $this->users->auth_servers_privileges['UPLOAD_CONTENTS'] && $this->users->auth_servers_privileges['CHANGE_CONFIG']): ?>
			<div class="menu_icons"><a href="{site_url}web_ftp/server/{server_id}"><img src="{base_url}themes/{template}/{style}/images/icons/remote_folder.png" /><br />{lang_server_files_cfg_files}</a></div>
		<?php endif; ?>
      
		<?php if($this->users->auth_servers_privileges['CONSOLE_VIEW']): ?>
			<div class="menu_icons"><a href="{site_url}server_command/console_view/{server_id}"><img src="{base_url}themes/{template}/{style}/images/icons/console.png" /><br />{lang_server_control_console_view}</a></div>
		<?php endif; ?>

		<?php if($this->users->auth_servers_privileges['SERVER_SETTINGS']): ?>
			<div class="menu_icons"><a href="{site_url}admin/settings/server/{server_id}"><img src="{base_url}themes/{template}/{style}/images/icons/settings.png" /><br />{lang_server_control_settings}</a></div>
		<?php endif; ?>
		
		<?php if (module_exists('amxx_plugins_control') 
					&& strtolower($this->servers->server_data['engine']) == 'goldsource'
					&& $this->users->auth_servers_privileges['UPLOAD_CONTENTS'] 
					&& $this->users->auth_servers_privileges['CHANGE_CONFIG']
		): ?>
			<div class="menu_icons"><a href="{site_url}amxx_plugins_control/server/{server_id}"><img src="{base_url}themes/{template}/{style}/images/icons/plugins.png" /><br />AMXX Plugins</a></div>
		<?php endif; ?>
		
		<?php if (module_exists('chat') 
					&& strtolower($this->servers->server_data['engine']) == 'goldsource'
					&& $this->users->auth_servers_privileges['SERVER_CHAT_MSG']
		): ?>
			<div class="menu_icons"><a href="{site_url}chat/server/{server_id}"><img src="{base_url}themes/{template}/{style}/images/icons/chat.png" /><br />Chat</a></div>
		<?php endif; ?>
		
		<?php if($this->users->auth_data['is_admin']): ?>
			<div class="menu_icons"><a href="{site_url}adm_servers/edit/game_servers/{server_id}"><img src="{base_url}themes/{template}/{style}/images/icons/administration.png" /><br />{lang_administration}</a></div>
		<?php endif; ?>
		
		<?php if($this->users->auth_servers_privileges['CHANGE_RCON']): ?>
			<div class="menu_icons"><a href="{site_url}rcon_changer/change/{server_id}"><img src="{base_url}themes/{template}/{style}/images/icons/field.png" /><br />Сменить RCON пароль</a></div>
		<?php endif; ?>

        {modules_menu}
            <div class="menu_icons"><a href="{modules_menu_link}"><img src="{modules_menu_icon}" /><br />{modules_menu_text}</a></div>
        {/modules_menu}
		
	</div>
</div>

<?php if ($this->servers->server_data['server_status']): ?>
	<?php /* Сервер запущен */ ?>
	
	<p class="hr"><strong>{lang_status}</strong></p>
	
	<table style="margin-left:100px;width:60%;" class="zebra">
		{base_cvars}
		<tr>
			<td width="35%">{cvar_name}:</td>
			<td>{cvar_value}</td>
		</tr>
		{/base_cvars}
	</table>

	<?php if ($this->players): ?>
		<p class="hr"><strong>{lang_server_control_players_control}</strong></p>
		<table width="100%" class="zebra">
			<thead>
				<tr>
					<th><strong>{lang_nick}</strong></th>
					<th><strong>{lang_steamid}</strong></th>
					<th><strong>{lang_ip}</strong></th>
					<th><strong>{lang_commands}</strong></th>
				</tr>
			</thead>
		{users_list}
			<tr>
				<td width="20%">{user_name}</td>
				<td width="20%">{steam_id}</td>
				<td width="20%">{user_ip}</td>
				<td>
					<?php if ($this->servers->server_data['kick_cmd']): ?>
						<a class="small awesome" href="{site_url}server_command/rcon/pl_kick/{server_id}/{user_id}/">{lang_server_control_kick}<a/> 
					<?php endif; ?>
					
					<?php if ($this->servers->server_data['ban_cmd']): ?>
						<a class="small awesome" href="{site_url}server_command/rcon/pl_ban/{server_id}/{user_id}/">{lang_server_control_ban}<a/> 
					<?php endif; ?>
					
					<?php if ($this->servers->server_data['chname_cmd']): ?>
						<a class="small awesome" href="{site_url}server_command/rcon/pl_changename/{server_id}/{user_id}/">{lang_server_control_ch_name}<a/>
					<?php endif; ?>
				</td>
			</tr>
		{/users_list}
		</table>
	<?php endif; ?>

	<?php if ($this->users->auth_servers_privileges['FAST_RCON']): ?>
		<p class="hr"><strong>{lang_rcon}</strong></p>
		<form action="{site_url}server_command/rcon/rcon_command/{server_id}" method="post" accept-charset="utf-8">
			<input type="hidden" name="{csrf_token_name}" value="{csrf_hash}" />
		<table width="50%">
			<tr>
				<td colspan="2"><p>{frcon_list}<a class="small awesome" href="{site_url}server_command/rcon/fast/{server_id}/{id_fr}/{csrf_hash}">{desc}<a/>&nbsp;{/frcon_list}</p></td>
			</tr>
		<?php if ($this->users->auth_servers_privileges['RCON_SEND']): ?>
			<tr>
			<td>{lang_server_control_rcon_command}:</td>
			<td><input type="text" name="rcon_command" size="32"/>&nbsp;&nbsp;<input type="submit" name="submit_rcon" value="{lang_send}" /></td>
			</tr>
		<?php endif; /* RCON */?>
		</table>
		</form>
	<?php endif; ?>

	<?php if ($this->servers->server_data['sendmsg_cmd']): ?>
		<p class="hr"><strong>{lang_server_control_chat}</strong></p>
		<form action="{site_url}server_command/rcon/send_msg/{server_id}/" method="post" accept-charset="utf-8">
			<input type="hidden" name="{csrf_token_name}" value="{csrf_hash}" />
			<table width="75%">
				<tr>
					<td>Сообщение:</td>
					<td><input type="text" name="msg_text" size="50"/>&nbsp;&nbsp;<input type="submit" name="submit_sendmsg" value="{lang_send}" /></td>
				</tr>
			</table>
		</form>
	<?php endif; ?>

	<?php if ($this->users->auth_servers_privileges['SERVER_SET_PASSWORD'] && $this->servers->server_data['passwd_cmd']): ?>
	<p class="hr"><strong>{lang_server_control_password_to_server}</strong></p>
		<form action="{site_url}server_command/rcon/set_password/{server_id}" method="post" accept-charset="utf-8">
			<input type="hidden" name="{csrf_token_name}" value="{csrf_hash}" />
			<table width="50%">
				<tr>
					<td>{lang_server_control_set_password}:</td>
					<td><input type="text" name="password" size="16"/>&nbsp;&nbsp;<input type="submit" name="submit_set_password" value="{lang_send}" /><br />
					{lang_server_control_leave_blank_that_unset}</td>
				</tr>
			</table>
		</form>
	<?php endif; ?>

<?php endif; ?>

<script>
    $('#start-server').click(function() {
        server_act('gsstart');
        return false;
    });
    
    $('#stop-server').click(function() {
        server_act('gsstop');
        return false;
    });
    
    $('#restart-server').click(function() {
        server_act('gsrest');
        return false;
    });
    
    $('#update-server').click(function() {
        server_act('gsinst');
        return false;
    });
</script>
